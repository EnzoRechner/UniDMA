// This file centralizes all authentication logic for Firebase Firestore.

import { getApp, getApps, initializeApp } from 'firebase/app';
import { collection, doc, getDocs, getFirestore, query, setDoc, where } from 'firebase/firestore';

// Your Firebase configuration.
// Replace with your actual configuration if you're not using the automatic setup.
const firebaseConfig = {
  // ... your firebase config here ...
};

// Initialize Firebase if it hasn't been initialized yet
if (!getApps().length) {
  initializeApp(firebaseConfig);
}

// Default export for module compatibility
export default { signUpUser, loginUser };

const db = getFirestore(getApp());

// Generates a random 6-digit number for the user's document ID.
function generateRandomId() {
  return Math.floor(100000 + Math.random() * 900000).toString();
}

/**
 * Signs up a new user by adding them to the 'users' collection.
 * It first checks if the email already exists to prevent duplicate accounts.
 * @param {string} email - The user's email address.
 * @param {string} password - The user's password.
 * @param {string} nagName - The user's name.
 * @param {string} dob - The user's date of birth (YYYY-MM-DD).
 * @returns {Promise<{success: boolean, message: string, userId?: string}>} - An object indicating success or failure.
 */
export async function signUpUser(email: string, password: string, nagName: string, dob: string) {
  try {

  
    // Check if the email already exists in the 'users' collection
    const q = query(
      collection(db, 'users'),
      where('email', '==', email)
    );
    const snapshot = await getDocs(q);

    if (!snapshot.empty) {
      return { success: false, message: 'Email already exists.' };
    }

    // Generate a random 6-digit document ID
    const documentId = generateRandomId();
    
    // Save the new user document to the 'users' collection
    await setDoc(doc(db, 'users', documentId), {
      email,
      password, // Note: Storing plain text passwords is a security risk. Consider hashing them.
      nagName,
      DOB: dob,
      role: 0, // Always set the role to 0 for new sign-ups
    });

    return { success: true, message: `Account created successfully! Your ID: ${documentId}`, userId: documentId };

  } catch (error) {
    console.error('Sign-up failed:', error);
    return { success: false, message: 'Failed to sign up. Please try again later.' };
  }
}

  /**
 * Logs in a user by checking their email and password against the 'users' collection.
 * @param {string} email - The user's email address.
 * @param {string} password - The user's password.
 * @returns {Promise<{success: boolean, message: string, userId?: string, role?: string}>} - An object indicating the login result and user data if successful.
 */
export async function loginUser(email: string, password:string) {
  try {
    // Query the users collection for a document with the provided email
    const q = query(
      collection(db, 'users'),
      where('email', '==', email)
    );
    const querySnapshot = await getDocs(q);

    if (querySnapshot.empty) {
      return { success: false, message: 'Invalid email or password.' };
    }

    // Since emails are unique, there should only be one document
    const userDoc = querySnapshot.docs[0];
    const userData = userDoc.data();

    // Check if the password matches.
    // NOTE: In a production app, you would compare hashed passwords.
    if (userData.password === password) {
      return {
        success: true,
        message: 'Login successful!',
        userId: userDoc.id,
        role: userData.role,
      };
    } else {
      return { success: false, message: 'Invalid email or password.' };
    }
  } catch (error) {
    console.error('Login failed:', error);
    return { success: false, message: 'Failed to login. Please try again later.' };
  }
}
